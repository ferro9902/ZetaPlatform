# =============================================================================
# ZetaPlatform – Application Deployments
# Namespace: aruba
#
# Images are built by GitHub Actions and pushed to ghcr.io.
# Prerequisites:
#   kubectl apply -f 01-infrastructure.yaml
#   kubectl apply -f 02-config.yaml
# =============================================================================

# -----------------------------------------------------------------------------
# user-mgmt-service
# gRPC server on 9090 | PostgreSQL: user_mgmt_db
# No outbound gRPC calls; standalone data service.
# Probes use the standard gRPC health protocol (grpc.health.v1.Health),
# registered automatically by the Spring gRPC starter.
# -----------------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-mgmt-service
  namespace: aruba
spec:
  replicas: 1
  selector:
    matchLabels:
      app: user-mgmt-service
  template:
    metadata:
      labels:
        app: user-mgmt-service
    spec:
      containers:
        - name: app
          image: ghcr.io/ferro9902/user-mgmt-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 9090
              name: grpc
          envFrom:
            - configMapRef:
                name: zeta-config
            - secretRef:
                name: zeta-secrets
          env:
            # Service-specific DB URL — overrides anything from envFrom
            - name: DB_URL
              value: "jdbc:postgresql://postgres-db:5432/user_mgmt_db"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          readinessProbe:
            grpc:
              port: 9090
            initialDelaySeconds: 20
            periodSeconds: 10
            failureThreshold: 5
          livenessProbe:
            grpc:
              port: 9090
            initialDelaySeconds: 40
            periodSeconds: 15
            failureThreshold: 3

---
apiVersion: v1
kind: Service
metadata:
  name: user-mgmt-service
  namespace: aruba
spec:
  selector:
    app: user-mgmt-service
  ports:
    - port: 9090
      targetPort: 9090
      name: grpc

---
# -----------------------------------------------------------------------------
# user-auth-service
# gRPC server on 9090 | PostgreSQL: user_auth_db
# Outbound gRPC client → user-mgmt-service:9090
# Probes use the standard gRPC health protocol (grpc.health.v1.Health),
# registered automatically by the Spring gRPC starter.
# -----------------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-auth-service
  namespace: aruba
spec:
  replicas: 1
  selector:
    matchLabels:
      app: user-auth-service
  template:
    metadata:
      labels:
        app: user-auth-service
    spec:
      containers:
        - name: app
          image: ghcr.io/ferro9902/user-auth-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 9090
              name: grpc
          envFrom:
            - configMapRef:
                name: zeta-config
            - secretRef:
                name: zeta-secrets
          env:
            # Service-specific DB URL — overrides anything from envFrom
            - name: DB_URL
              value: "jdbc:postgresql://postgres-db:5432/user_auth_db"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          readinessProbe:
            grpc:
              port: 9090
            initialDelaySeconds: 20
            periodSeconds: 10
            failureThreshold: 5
          livenessProbe:
            grpc:
              port: 9090
            initialDelaySeconds: 40
            periodSeconds: 15
            failureThreshold: 3

---
apiVersion: v1
kind: Service
metadata:
  name: user-auth-service
  namespace: aruba
spec:
  selector:
    app: user-auth-service
  ports:
    - port: 9090
      targetPort: 9090
      name: grpc

---
# -----------------------------------------------------------------------------
# pec-integration-service
# gRPC server on 9090 | HTTP actuator on 8080 | No database
# Outbound gRPC clients → user-auth-service:9090, user-mgmt-service:9090
# Outbound REST → aruba-api-mock:8080 (WireMock, overridden via ConfigMap)
# -----------------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pec-integration-service
  namespace: aruba
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pec-integration-service
  template:
    metadata:
      labels:
        app: pec-integration-service
    spec:
      containers:
        - name: app
          image: ghcr.io/ferro9902/pec-integration-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 9090
              name: grpc
            - containerPort: 8080
              name: http
          envFrom:
            - configMapRef:
                name: zeta-config
            - secretRef:
                name: zeta-secrets
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 5
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 15
            failureThreshold: 3

---
apiVersion: v1
kind: Service
metadata:
  name: pec-integration-service
  namespace: aruba
spec:
  selector:
    app: pec-integration-service
  ports:
    - port: 9090
      targetPort: 9090
      name: grpc
    - port: 8080
      targetPort: 8080
      name: http
